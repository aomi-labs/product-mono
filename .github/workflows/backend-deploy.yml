# DEPRECATED: Use deploy-v2.yml instead
# This file is kept for reference during transition
# TODO: Remove after deploy-v2.yml is verified working
name: Deploy Backend (staging & prod) [DEPRECATED]

on:
  workflow_run:
    workflows:
      - Build and Push Docker Images
    types:
      - completed

jobs:
  deploy-staging:
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push' &&
      github.event.workflow_run.head_branch == 'main'
    runs-on: blacksmith-4vcpu-ubuntu-2404
    steps:
      - name: Deploy backend on preview host
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.STAGING_SSH_HOST }}
          username: ${{ secrets.STAGING_SSH_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            set -euo pipefail
            export PATH="/snap/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:$PATH"
            cd /root/product-mono
            git fetch origin main
            git checkout main
            git pull --ff-only origin main
            ./scripts/compose-backend-prod.sh main
      - name: Verify staging backend health
        run: |
          set -euo pipefail
          response="$(curl -fsS https://api.staging.aomi.dev/health | tr -d '\r\n')"
          response="${response%%%}" # strip trailing %
          if [[ "$response" != "OK" ]]; then
            echo "Unexpected health response: $response"
            exit 1
          fi

  deploy-prod:
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push' &&
      github.event.workflow_run.head_branch == 'prod-v3'
    runs-on: blacksmith-4vcpu-ubuntu-2404
    steps:
      - name: Deploy backend on production host
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.PROD_SSH_HOST }}
          username: ${{ secrets.PROD_SSH_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            set -euo pipefail
            export PATH="/snap/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:$PATH"
            cd /root/product-mono
            git fetch origin prod-v3
            git checkout prod-v3
            git pull --ff-only origin prod-v3
            ./scripts/compose-backend-prod.sh prod-v3
      - name: Verify production backend health
        run: |
          set -euo pipefail
          response="$(curl -fsS https://api.aomi.dev/health | tr -d '\r\n')"
          response="${response%%%}" # strip trailing %
          if [[ "$response" != "OK" ]]; then
            echo "Unexpected health response: $response"
            exit 1
          fi
