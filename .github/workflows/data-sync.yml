name: Data Sync (Contracts)

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      target:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - prod
          - both

env:
  SCRIPTS_PATH: scripts

jobs:
  sync-staging:
    name: Sync Contracts (Staging)
    if: >
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && (inputs.target == 'staging' || inputs.target == 'both'))
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout scripts
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            scripts/fetch_contracts.sh
            scripts/top_contracts.csv

      - name: Run contract sync on staging
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.STAGING_SSH_HOST }}
          username: ${{ secrets.STAGING_SSH_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          command_timeout: 30m
          script: |
            set -euo pipefail
            
            SYNC_DIR="/tmp/contract-sync-$$"
            mkdir -p "$SYNC_DIR"
            cd "$SYNC_DIR"
            
            echo "ðŸ“¥ Fetching sync scripts..."
            curl -fsSL "https://raw.githubusercontent.com/${{ github.repository }}/main/scripts/fetch_contracts.sh" -o fetch_contracts.sh
            curl -fsSL "https://raw.githubusercontent.com/${{ github.repository }}/main/scripts/top_contracts.csv" -o top_contracts.csv
            chmod +x fetch_contracts.sh
            
            echo "ðŸ”„ Running contract sync..."
            export ETHERSCAN_API_KEY="${{ secrets.ETHERSCAN_API_KEY }}"
            export DATABASE_URL="${{ secrets.STAGING_DATABASE_URL }}"
            export PSQL_BIN="psql"
            
            ./fetch_contracts.sh
            
            rm -rf "$SYNC_DIR"
            
            echo "âœ… Contract sync complete!"

      - name: Report sync status
        if: always()
        run: |
          echo "## Contract Sync Status" >> $GITHUB_STEP_SUMMARY
          echo "- **Target:** Staging" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY

  sync-prod:
    name: Sync Contracts (Production)
    if: >
      github.event_name == 'workflow_dispatch' && (inputs.target == 'prod' || inputs.target == 'both')
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Checkout scripts
        uses: actions/checkout@v4
        with:
          ref: prod-v3
          sparse-checkout: |
            scripts/fetch_contracts.sh
            scripts/top_contracts.csv

      - name: Run contract sync on production
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.PROD_SSH_HOST }}
          username: ${{ secrets.PROD_SSH_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          command_timeout: 30m
          script: |
            set -euo pipefail
            
            SYNC_DIR="/tmp/contract-sync-$$"
            mkdir -p "$SYNC_DIR"
            cd "$SYNC_DIR"
            
            echo "ðŸ“¥ Fetching sync scripts..."
            curl -fsSL "https://raw.githubusercontent.com/${{ github.repository }}/prod-v3/scripts/fetch_contracts.sh" -o fetch_contracts.sh
            curl -fsSL "https://raw.githubusercontent.com/${{ github.repository }}/prod-v3/scripts/top_contracts.csv" -o top_contracts.csv
            chmod +x fetch_contracts.sh
            
            echo "ðŸ”„ Running contract sync..."
            export ETHERSCAN_API_KEY="${{ secrets.ETHERSCAN_API_KEY }}"
            export DATABASE_URL="${{ secrets.PROD_DATABASE_URL }}"
            export PSQL_BIN="psql"
            
            ./fetch_contracts.sh
            
            rm -rf "$SYNC_DIR"
            
            echo "âœ… Contract sync complete!"

      - name: Report sync status
        if: always()
        run: |
          echo "## Contract Sync Status" >> $GITHUB_STEP_SUMMARY
          echo "- **Target:** Production" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
