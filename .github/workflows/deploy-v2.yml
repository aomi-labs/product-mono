name: Deploy Backend v2 (Stateless)

# Triggered after Docker images are built and pushed
on:
  workflow_run:
    workflows:
      - Build and Push Docker Images
    types:
      - completed

env:
  DEPLOY_DIR: /opt/aomi
  HEALTH_TIMEOUT: 30

jobs:
  deploy-staging:
    name: Deploy to Staging
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push' &&
      github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout (for compose file)
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            docker/docker-compose-backend.yml

      - name: Deploy to staging server
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.STAGING_SSH_HOST }}
          username: ${{ secrets.STAGING_SSH_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          envs: ANTHROPIC_API_KEY,OPENAI_API_KEY,ETHERSCAN_API_KEY
          script: |
            set -euo pipefail
            export PATH="/snap/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:$PATH"
            
            export IMAGE_TAG="main"
            export DEPLOY_DIR="/opt/aomi"
            export BACKEND_PORT="${BACKEND_PORT:-8081}"
            
            # Ensure deploy directory exists
            mkdir -p "$DEPLOY_DIR"
            cd "$DEPLOY_DIR"
            
            # Pull latest image
            echo "üì• Pulling backend image..."
            docker pull ghcr.io/aomi-labs/product-mono/backend:$IMAGE_TAG
            
            # Stop existing containers gracefully
            echo "üõë Stopping existing containers..."
            docker compose -f docker-compose.yml down --timeout 30 || true
            
            # Clean up old images
            docker image prune -f || true
            
            # Start services
            echo "üöÄ Starting services..."
            docker compose -f docker-compose.yml up -d --force-recreate
            
            # Wait for health
            echo "‚è≥ Waiting for services to be healthy..."
            sleep 10
            
            # Verify health
            echo "üîç Checking health..."
            curl -fsS --retry 3 --retry-delay 5 "http://127.0.0.1:${BACKEND_PORT}/health"
            
            echo "‚úÖ Staging deployment complete!"
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}

      - name: Copy compose file to server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.STAGING_SSH_HOST }}
          username: ${{ secrets.STAGING_SSH_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          source: "docker/docker-compose-backend.yml"
          target: "/opt/aomi/"
          strip_components: 1

      - name: Verify external health endpoint
        run: |
          sleep 5
          response=$(curl -fsS --retry 5 --retry-delay 10 "https://api.staging.aomi.dev/health" || echo "FAILED")
          if [[ "$response" != "OK" ]]; then
            echo "‚ùå Health check failed: $response"
            exit 1
          fi
          echo "‚úÖ External health check passed"

  deploy-prod:
    name: Deploy to Production
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push' &&
      github.event.workflow_run.head_branch == 'prod-v3'
    runs-on: ubuntu-latest
    environment: production  # Requires approval
    
    steps:
      - name: Checkout (for compose file)
        uses: actions/checkout@v4
        with:
          ref: prod-v3
          sparse-checkout: |
            docker/docker-compose-backend.yml

      - name: Deploy to production server
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.PROD_SSH_HOST }}
          username: ${{ secrets.PROD_SSH_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          envs: ANTHROPIC_API_KEY,OPENAI_API_KEY,ETHERSCAN_API_KEY
          script: |
            set -euo pipefail
            export PATH="/snap/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:$PATH"
            
            export IMAGE_TAG="prod-v3"
            export DEPLOY_DIR="/opt/aomi"
            export BACKEND_PORT="${BACKEND_PORT:-8081}"
            
            mkdir -p "$DEPLOY_DIR"
            cd "$DEPLOY_DIR"
            
            echo "üì• Pulling backend image..."
            docker pull ghcr.io/aomi-labs/product-mono/backend:$IMAGE_TAG
            
            echo "üõë Stopping existing containers..."
            docker compose -f docker-compose.yml down --timeout 30 || true
            
            docker image prune -f || true
            
            echo "üöÄ Starting services..."
            docker compose -f docker-compose.yml up -d --force-recreate
            
            echo "‚è≥ Waiting for services to be healthy..."
            sleep 15
            
            echo "üîç Checking health..."
            curl -fsS --retry 3 --retry-delay 5 "http://127.0.0.1:${BACKEND_PORT}/health"
            
            echo "‚úÖ Production deployment complete!"
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}

      - name: Copy compose file to server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.PROD_SSH_HOST }}
          username: ${{ secrets.PROD_SSH_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          source: "docker/docker-compose-backend.yml"
          target: "/opt/aomi/"
          strip_components: 1

      - name: Verify external health endpoint
        run: |
          sleep 5
          response=$(curl -fsS --retry 5 --retry-delay 10 "https://api.aomi.dev/health" || echo "FAILED")
          if [[ "$response" != "OK" ]]; then
            echo "‚ùå Health check failed: $response"
            exit 1
          fi
          echo "‚úÖ External health check passed"
