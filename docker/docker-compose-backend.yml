# Aomi Backend Services
#
# This is the APPLICATION layer - deployed by CI on every release.
# Connects to DigitalOcean Managed PostgreSQL.
#
# Deploy: docker compose -f docker-compose-backend.yml up -d
# 
# Required environment variables:
#   - IMAGE_TAG: Docker image tag (e.g., main, prod-v3)
#   - DATABASE_URL: PostgreSQL connection string (DO Managed DB)
#   - ANTHROPIC_API_KEY: For AI features
#
# Optional:
#   - OPENAI_API_KEY: For AI features
#   - BACKEND_PORT: API port (default: 8081)
#   - RUST_LOG: Log level (default: info)

services:
  backend:
    image: ghcr.io/aomi-labs/product-mono/backend:${IMAGE_TAG:-latest}
    container_name: aomi-backend
    environment:
      - BACKEND_HOST=0.0.0.0
      - BACKEND_PORT=${BACKEND_PORT:-8081}
      - BACKEND_SKIP_DOCS=${BACKEND_SKIP_DOCS:-true}
      - BACKEND_SKIP_MCP=${BACKEND_SKIP_MCP:-true}
      - RUST_LOG=${RUST_LOG:-info}
      # Connect to DigitalOcean Managed PostgreSQL (VPC endpoint)
      - DATABASE_URL=${DATABASE_URL}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANVIL_HOST=0.0.0.0
    ports:
      - "${BACKEND_PORT:-8081}:${BACKEND_PORT:-8081}"
      - "8545:8545"
    volumes:
      - ${PROVIDERS_TOML_PATH:-./providers.toml}:/app/providers.toml:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${BACKEND_PORT:-8081}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
