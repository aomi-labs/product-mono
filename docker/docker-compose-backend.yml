# Aomi Backend Services
#
# This is the APPLICATION layer - deployed by CI on every release.
# Connects to the persistent database (docker-compose-db.yml).
#
# Prerequisites:
#   - Database must be running: docker compose -f docker-compose-db.yml up -d
#   - The aomi-network must exist (created by docker-compose-db.yml)
#
# Deploy: docker compose -f docker-compose-backend.yml up -d
# 
# Required environment variables:
#   - IMAGE_TAG: Docker image tag (e.g., main, prod-v3)
#   - ANTHROPIC_API_KEY: For AI features
#
# Optional:
#   - OPENAI_API_KEY: For AI features
#   - DATABASE_URL: Override database connection (default: connects to aomi-db container)
#   - BACKEND_PORT: API port (default: 8081)
#   - RUST_LOG: Log level (default: info)
#   - POSTGRES_PASSWORD: Must match docker-compose-db.yml (default: aomi_local)

services:
  backend:
    image: ghcr.io/aomi-labs/product-mono/backend:${IMAGE_TAG:-latest}
    container_name: aomi-backend
    environment:
      - BACKEND_HOST=0.0.0.0
      - BACKEND_PORT=${BACKEND_PORT:-8081}
      - BACKEND_SKIP_DOCS=${BACKEND_SKIP_DOCS:-true}
      - BACKEND_SKIP_MCP=${BACKEND_SKIP_MCP:-true}
      - RUST_LOG=${RUST_LOG:-info}
      # Connect to the persistent postgres container via Docker network
      - DATABASE_URL=${DATABASE_URL:-postgres://aomi:${POSTGRES_PASSWORD:-aomi_local}@aomi-db:5432/chatbot}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANVIL_HOST=0.0.0.0
    ports:
      - "${BACKEND_PORT:-8081}:${BACKEND_PORT:-8081}"
      - "8545:8545"
    volumes:
      - ${PROVIDERS_TOML_PATH:-./providers.toml}:/app/providers.toml:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${BACKEND_PORT:-8081}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - aomi-network

networks:
  aomi-network:
    name: aomi-network
    external: true  # Must be created by docker-compose-db.yml first
